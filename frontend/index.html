<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<title>Monitoreo Robot R1</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  :root { --bg:#0f172a; --card:#111827; --fg:#e5e7eb; --muted:#9ca3af; }
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial;background:var(--bg);color:var(--fg)}
  header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#0b1220;border-bottom:1px solid #1f2937}
  header b{letter-spacing:.3px}
  #wrap{display:grid;grid-template-columns:1.4fr .6fr;gap:12px;padding:12px}
  #map{height:78vh;border-radius:14px;overflow:hidden;border:1px solid #1f2937}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:14px;padding:12px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#1e293b;border:1px solid #334155;color:#e2e8f0;border-radius:10px;padding:8px 10px;cursor:pointer}
  button:hover{background:#0b1220}
  .pill{display:inline-block;padding:3px 8px;border:1px solid #334155;border-radius:999px;color:#cbd5e1}
  .muted{color:var(--muted);font-size:.9rem}
  pre{white-space:pre-wrap;word-wrap:break-word;max-height:28vh;overflow:auto;background:#0b1220;border-radius:10px;padding:10px;border:1px solid #1f2937}
  @media (max-width: 980px){ #wrap{grid-template-columns:1fr} #map{height:60vh} }
</style>
</head>
<body>
<header>
  <b>Robot R1 · Mapa en tiempo real (MQTT)</b>
  <span class="pill" id="status">MQTT: desconectado</span>
</header>

<div id="wrap">
  <div id="map"></div>

  <div class="card">
    <div class="row" style="margin-bottom:8px">
      <button id="btnAuto">Modo AUTO</button>
      <button id="btnManual">Modo MANUAL</button>
      <button id="btnPing">PING</button>
      <button data-rate="1000">Rate 1s</button>
      <button data-rate="2000">Rate 2s</button>
      <button data-rate="5000">Rate 5s</button>
    </div>
    <div class="muted" id="info">Esperando telemetría…</div>
    <pre id="log"></pre>
  </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
  // === Configura tus topics/broker ===
  const TOPIC_UP   = 'iot/telemetry/up';   // publicado por tu gateway
  const TOPIC_DOWN = 'iot/commands/down';  // comandos hacia tu gateway
  const MQTT_URL   = 'wss://test.mosquitto.org:8081/mqtt'; // o ws://<tu_ip>:<puerto>/mqtt

  // === Mapa ===
  const map = L.map('map').setView([19.24, -103.45], 15);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    { maxZoom: 19, attribution:'© OpenStreetMap' }).addTo(map);
  const marker = L.marker([19.24, -103.45]).addTo(map);
  const track  = L.polyline([], {weight:4}).addTo(map);

  // === UI helpers ===
  const $status = document.getElementById('status');
  const $log    = document.getElementById('log');
  const $info   = document.getElementById('info');
  function log(s){ $log.textContent = (s + '\n' + $log.textContent).slice(0, 8000); }

  // === MQTT ===
  const client = mqtt.connect(MQTT_URL, {keepalive:30, reconnectPeriod:2000});
  client.on('connect', () => {
    $status.textContent = 'MQTT: conectado';
    $status.style.borderColor = '#16a34a';
    client.subscribe(TOPIC_UP);
    log('[MQTT] Conectado. Suscrito a ' + TOPIC_UP);
  });
  client.on('reconnect', () => { $status.textContent='MQTT: reconectando…'; });
  client.on('close', () => { $status.textContent='MQTT: desconectado'; $status.style.borderColor='#334155'; });
  client.on('error', (e) => log('[MQTT error] ' + e.message));

  client.on('message', (_, payload) => {
    try{
      const msg = JSON.parse(payload.toString());
      const [lon, lat] = msg?.pos?.coordinates || [null, null];
      if(lat!=null && lon!=null){
        marker.setLatLng([lat, lon]);
        track.addLatLng([lat, lon]);
        $info.textContent = `lat=${lat.toFixed(6)}  lon=${lon.toFixed(6)}  alt=${(msg.alt??0).toFixed(1)}  spd=${(msg.spd??0).toFixed(2)}  mode=${msg.mode}  sats=${msg.sats}`;
        // map.panTo([lat,lon]); // descomenta si quieres que siga la posición
      }
      log('[UP] ' + JSON.stringify(msg));
    }catch(e){
      log('[Parse] ' + e.message);
    }
  });

  // === Envío de comandos ===
  function sendCmd(obj){
    const s = JSON.stringify(obj);
    client.publish(TOPIC_DOWN, s);
    log('[DOWN] ' + s);
  }
  document.getElementById('btnAuto').onclick   = () => sendCmd({cmd:'SET_MODE', mode:'AUTO'});
  document.getElementById('btnManual').onclick = () => sendCmd({cmd:'SET_MODE', mode:'MANUAL'});
  document.getElementById('btnPing').onclick   = () => sendCmd({cmd:'PING'});
  document.querySelectorAll('button[data-rate]').forEach(b=>{
    b.onclick = ()=> sendCmd({cmd:'SET_RATE', period_ms: parseInt(b.dataset.rate,10)});
  });
</script>
</body>
</html>
